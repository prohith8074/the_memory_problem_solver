graph LR
    %% Input sources
    DOC[📄 User Document<br/>PDF/Text]
    URL[🌐 Web URL<br/>Content]

    %% Processing pipeline (numbered steps)
    subgraph "Document Processing Pipeline"
        DP1[1️⃣ Parse Document<br/>LlamaParse/PyMuPDF]
        DP2[2️⃣ Contextualize/<br/>Enrich Text]
        DP3[3️⃣ Extract Entities<br/>& Relations]
        DP4[4️⃣ Generate Embeddings<br/>Cohere API]
        DP5[5️⃣ Create Text<br/>Embeddings Store]
    end

    %% Query processing pipeline
    subgraph "Query Processing Pipeline"
        QP1[🔍 Vector Search<br/>Qdrant DB]
        QP2[📊 Hybrid Scorer<br/>RRF Algorithm]
        QP3[🧠 Graph Traversal<br/>Knowledge Graph]
        QP4[🎯 Logical Filter<br/>Context Matching]
        QP5[⚡ Execution Engine<br/>Query Processing]
        QP6[🤖 Response Generator<br/>Cohere API]
    end

    %% Data storage
    KG[(🕸️ Knowledge Graph DB<br/>Neo4j/Neptune)]
    VEC[(🗄️ Vector DB<br/>Qdrant)]
    MEM[(💾 Short-term Memory<br/>Redis/Cachet])

    %% Management and monitoring
    MGMT[✏️ Ontology Editor<br/>Gradio Interface]
    KG_BUILD[📈 Build & Version<br/>Knowledge Graph]
    TRACER[📋 Opik Tracer<br/>LLM Monitoring]
    ROUTER[🔀 Query Router<br/>Smart Routing]

    %% User interaction
    QUERY[❓ User Query]
    ANSWER[✅ Final Answer]

    %% Document processing flow
    DOC --> DP1
    URL --> DP1
    DP1 --> DP2
    DP2 --> DP3
    DP3 --> KG
    DP3 --> DP4
    DP4 --> DP5
    DP5 --> VEC

    %% Management flow
    MGMT --> KG_BUILD
    KG_BUILD --> KG

    %% Query processing flow
    QUERY --> ROUTER
    ROUTER --> QP1
    ROUTER --> MEM

    QP1 --> QP2
    QP2 --> QP3
    QP3 --> QP4
    QP4 --> QP5
    QP5 --> QP6

    KG -.-> QP3
    VEC -.-> QP1
    MEM -.-> QP5

    QP6 --> ANSWER

    %% Monitoring and tracing
    TRACER -.-> ROUTER
    TRACER -.-> QP6

    %% Styling to match the reference image
    classDef input fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef process fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef storage fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef query fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef management fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef output fill:#e3f2fd,stroke:#1976d2,stroke-width:2px

    class DOC,URL input
    class DP1,DP2,DP3,DP4,DP5 process
    class KG,VEC,MEM storage
    class QP1,QP2,QP3,QP4,QP5,QP6,ROUTER query
    class MGMT,KG_BUILD,TRACER management
    class QUERY,ANSWER output

    %% Custom styling for step numbers
    class DP1,DP2,DP3,DP4,DP5 process
    class QP1,QP2,QP3,QP4,QP5,QP6 query